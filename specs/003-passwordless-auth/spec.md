# 功能規格說明：增強型無密碼認證系統

**功能分支**: `003-passwordless-auth`
**建立日期**: 2025-11-20
**狀態**: 草稿
**輸入說明**: 使用者描述："改進身份驗證和角色型系統。在生產環境中啟用無密碼認證，支援 Google OAuth 和魔法連結，提升安全性和使用者體驗。"

---

## 使用者情景與測試 *(必填)*

### 使用者故事 1 - Google OAuth 登入 (優先級：P1)

一位家長使用者來到登入頁面，想要快速存取孩子的電子報，而不需要記住密碼。他們點擊「使用 Google 登入」按鈕，使用他們每天已經使用的 Google 帳號進行驗證，然後立即登入到 CMS。

**為什麼是此優先級**: Google OAuth 消除了使用者管理密碼的負擔，同時通過委託給 Google 的基礎架構來顯著提高帳號安全性。這是大多數使用者最順暢的認證方式。

**獨立測試**: 可以通過使用者點擊「使用 Google 登入」、完成 OAuth 流程、被重新導向到儀表板來完全測試。無需魔法連結或備用方法即可提供即時價值。

**驗收情景**:

1. **已知** 新使用者在登入頁面，**當** 他們點擊「使用 Google 登入」，**則** 他們被重新導向到 Google 的 OAuth 同意畫面
2. **已知** 使用者完成 Google OAuth，**當** Google 重新導向回應用程式，**則** 使用者自動登入並被重新導向到他們的儀表板
3. **已知** 現有使用者之前使用 Google 登入，**當** 他們再次使用 Google 登入，**則** 他們立即登入（無需帳號建立）
4. **已知** 使用者取消 Google OAuth 流程，**當** 他們被重新導向回來，**則** 他們看到登入頁面，之前的狀態保持不變

---

### 使用者故事 2 - 魔法連結電子郵件認證 (優先級：P1)

一位家長使用者不願使用 Google OAuth 或遇到問題。他們輸入電子郵件地址，點擊「傳送魔法連結」，收到包含安全一次性連結的電子郵件，點擊它，然後無需輸入任何密碼即可登入。

**為什麼是此優先級**: 魔法連結為不擁有或不願使用 Google 帳號的使用者提供無密碼備用方案。對於實現 100% 無密碼覆蓋和改進可訪問性至關重要。

**獨立測試**: 可以通過輸入電子郵件、收到魔法連結電子郵件、點擊連結並登入來完全測試。單獨來說，這為沒有 OAuth 提供者的使用者提供了完整的認證能力。

**驗收情景**:

1. **已知** 使用者在登入頁面，**當** 他們選擇「魔法連結」並輸入他們的電子郵件，**則** 他們看到確認訊息並發送電子郵件
2. **已知** 使用者收到魔法連結電子郵件，**當** 他們在 15 分鐘內點擊連結，**則** 他們登入並且連結被無效化
3. **已知** 使用者收到魔法連結電子郵件，**當** 他們試圖第二次使用同一連結，**則** 連結被拒絕，他們必須請求新的連結
4. **已知** 使用者試圖在 15 分鐘後使用魔法連結，**當** 他們點擊過期連結，**則** 他們看到表示連結已過期的訊息以及請求新連結的方式
5. **已知** 新電子郵件地址使用魔法連結，**當** 他們成功驗證，**則** 自動建立新使用者帳號

---

### 使用者故事 3 - 不同使用者類型的角色型存取控制 (優先級：P1)

管理員使用者可以管理教師和家長帳號。教師可以編輯指派給他們的班級的文章，但不能編輯其他班級的。家長只看到他們孩子班級的文章。所有存取權都基於使用者角色和關係在應用程式中一致地控制。

**為什麼是此優先級**: RBAC 是安全性和資料隔離的基礎。不同的使用者類型需要不同的功能，並且不能存取未授權的內容。此要求對於生產就緒至關重要。

**獨立測試**: 可以通過以不同角色類型（管理員、教師、家長、學生）登入並驗證他們只看到授權內容和存取權來測試。展示認證正確與授權整合。

**驗收情景**:

1. **已知** 管理員使用者已登入，**當** 他們導航到使用者管理部分，**則** 他們看到所有使用者並可以修改他們的角色
2. **已知** 教師已登入，**當** 他們試圖編輯他們未指派的班級的文章，**則** 他們看到「未授權」訊息
3. **已知** 家長已登入，**當** 他們查看電子報，**則** 他們只看到他們孩子班級的文章
4. **已知** 學生已登入，**當** 他們查看電子報，**則** 他們只看到公開文章，不看班級限制文章
5. **已知** 有多個班級孩子的家長已登入，**當** 他們查看電子報，**則** 他們看到來自所有孩子班級的文章

---

### 使用者故事 4 - 工作階段管理和多裝置支援 (優先級：P1)

家長在他們的行動電話上登入，瀏覽電子報，然後關閉應用程式。當他們稍後重新開啟時，他們保持登入狀態（在 30 天內）。他們也可以在平板上獨立登入。如果他們登出，兩個裝置都會受到影響（或只有該裝置，取決於偏好設定）。

**為什麼是此優先級**: 持久工作階段和多裝置支援提供了預期的現代網頁體驗。使用者期望在工作階段間保持登入狀態並能夠在多個裝置上使用。

**獨立測試**: 可以通過登入、關閉/重新開啟應用程式並驗證使用者保持登入狀態來測試。獨立測試工作階段持久化和自動重新整理機制。

**驗收情景**:

1. **已知** 使用者成功登入，**當** 他們在 30 天內關閉並重新開啟應用程式，**則** 他們保持登入狀態而無需重新驗證
2. **已知** 使用者在裝置 A 上登入，**當** 他們在裝置 B 上登入，**則** 兩個裝置保持獨立工作階段（並行登入支援）
3. **已知** 使用者從裝置 A 登出，**當** 他們檢查裝置 B，**則** 裝置 B 可能保持登入狀態（或登出跨裝置同步，取決於產品決策）
4. **已知** 權杖即將過期，**當** 使用者執行操作，**則** 權杖自動重新整理而使用者不會注意到
5. **已知** 權杖在 30 天後過期，**當** 使用者返回應用程式，**則** 他們必須重新驗證

---

### 使用者故事 5 - 帳號連結和合併 (優先級：P2)

先前建立密碼型帳號的家長想要將 Google OAuth 新增到他們現有帳號，以避免管理另一個密碼。他們使用他們現有的方法登入，存取帳號設定，並連結他們的 Google 帳號。未來的登入可以使用任一方法。

**為什麼是此優先級**: 帳號連結為舊系統的遷移提供了更順暢的路徑，並防止使用者在忘記使用哪個登入方法時感到沮喪。對於使用者留存很重要，但在核心無密碼功能之後是次要的。

**獨立測試**: 可以通過建立帳號、連結另一個認證方法並驗證兩種方法都有效來測試。獨立測試帳號合併工作流。

**驗收情景**:

1. **已知** 使用者使用電子郵件/密碼登入，**當** 他們存取帳號設定並點擊「連結 Google 帳號」，**則** 他們可以授權 Google 並連結它
2. **已知** 使用者已連結多個認證方法，**當** 他們使用任何方法登入，**則** 他們存取同一帳號
3. **已知** 使用者已連結多個認證方法，**當** 他們停用一個方法，**則** 其他方法仍然有效（防止鎖定）

---

### 使用者故事 6 - 安全性和稽核日誌 (優先級：P1)

管理員可以在稽核日誌中查看認證事件（登入嘗試、OAuth 完成、魔法連結使用）以進行合規性和安全監視。速率限制可防止對魔法連結的暴力攻擊。可疑活動會觸發通知。

**為什麼是此優先級**: 安全日誌和速率限制對於處理敏感使用者資料的生產系統至關重要。合規性和威脅偵測取決於稽核跟蹤。

**獨立測試**: 可以通過執行認證操作並驗證他們出現在具有適當時間戳和詳細資料的稽核日誌中來測試。可以通過模擬重複失敗嘗試來測試速率限制。

**驗收情景**:

1. **已知** 使用者通過 Google OAuth 驗證，**當** 認證完成，**則** 事件以使用者 ID、時間戳和認證方法記錄
2. **已知** 使用者從同一電子郵件請求多個魔法連結，**當** 他們超過速率限制（例如，每小時 5 個），**則** 進一步請求被暫時阻止
3. **已知** 來自同一 IP 的多個 OAuth 失敗嘗試，**當** 超過閾值，**則** 系統記錄可疑活動警報
4. **已知** 管理員查看稽核日誌，**當** 他們按認證方法篩選，**則** 他們看到按 OAuth 與魔法連結分離的所有登入事件

---

### 使用者故事 7 - 變更電子郵件地址與工作階段無效化 (優先級：P2)

一位家長使用者想要更新他們帳號的電子郵件地址（例如，更換工作電子郵件）。他們進入帳號設定，輸入新電子郵件，系統發送驗證連結到新地址。驗證後，舊電子郵件地址被替換，並且所有先前的登入工作階段在所有裝置上被無效化，迫使使用者使用新電子郵件重新登入以確保安全性。

**為什麼是此優先級**: 電子郵件變更是常見的帳號管理操作。工作階段無效化防止了帳號遭到入侵時舊電子郵件仍保持活躍存取的風險。對於帳號安全性很重要，但在核心認證功能之後是次要的。

**獨立測試**: 可以通過變更電子郵件、驗證新地址，然後確認舊工作階段已無效且使用者必須使用新電子郵件重新登入來測試。展示帳號管理與工作階段安全性的整合。

**驗收情景**:

1. **已知** 已登入使用者在帳號設定中，**當** 他們輸入新電子郵件地址並點擊「變更電子郵件」，**則** 驗證連結發送到新地址並顯示確認訊息
2. **已知** 使用者收到驗證電子郵件，**當** 他們點擊確認連結，**則** 電子郵件地址更新，舊地址無法再用於登入
3. **已知** 電子郵件地址已驗證，**當** 更新完成，**則** 所有現有工作階段在所有裝置上被無效化
4. **已知** 使用者在另一裝置上有活躍工作階段，**當** 電子郵件變更並驗證，**則** 另一裝置自動登出，下次操作時要求重新登入
5. **已知** 使用者試圖使用舊電子郵件登入，**當** 在新電子郵件設定後，**則** 登入被拒絕，要求使用新電子郵件或魔法連結
6. **已知** 使用者未驗證新電子郵件，**當** 他們關閉瀏覽器或放棄，**則** 原電子郵件地址保持不變，舊工作階段保持活躍

---

### 邊界情況

- 如果使用者的 Google 帳號電子郵件地址與 CMS 中的帳號電子郵件不符會發生什麼？（通過帳號連結或電子郵件驗證處理）
- 系統如何處理失去存取其電子郵件（魔法連結）或 Google 帳號的使用者？（提供管理員恢復機制）
- 如果魔法連結被與另一人共享會發生什麼？（連結是一次性使用；第二人無法使用它）
- 無驗證電子郵件的使用者可以使用魔法連結嗎？（是的，但在第一次成功的魔法連結使用時驗證電子郵件）
- 如果使用者使用 Google 登入，然後 Google 的 OAuth 提供者撤銷存取權會發生什麼？（使用者仍可以使用魔法連結；OAuth 連結從帳號中移除）
- 系統在 OAuth 提供者中斷期間的行為如何？（魔法連結備用選項保持可用）
- 如果魔法連結電子郵件進入垃圾郵件資料夾會怎樣？（提供重新傳送魔法連結的選項或提供替代認證方法）
- 密碼重設權杖在從密碼型認證遷移期間如何處理？（無效化所有現有權杖，強制通過新方法重新驗證）

---

## 要求 *(必填)*

### 功能要求

**認證方法**:
- **FR-001**: 系統必須支援 Google OAuth 2.0 作為主要認證方法
- **FR-002**: 系統必須支援通過電子郵件的魔法連結認證作為無密碼備用方案
- **FR-003**: 系統不得儲存密碼或對新登入使用密碼型認證
- **FR-004**: 系統必須允許使用者將多個認證方法連結到同一帳號
- **FR-005**: 系統必須在使用者設定中提供帳號連結介面

**工作階段管理**:
- **FR-006**: 系統必須發出 JWT 權杖，存取權杖過期時間為 15 分鐘，重新整理權杖過期時間為 30 天
- **FR-007**: 系統必須在過期前自動重新整理存取權杖
- **FR-008**: 系統必須支援同一使用者跨多個裝置的並行工作階段
- **FR-009**: 系統必須在瀏覽器本機儲存中持久化工作階段狀態，並在頁面重新載入時自動還原
- **FR-010**: 系統必須在使用者登出時清除所有權杖並在伺服器端無效化重新整理權杖

**授權和存取控制**:
- **FR-011**: 系統必須強制執行角色型存取控制 (RBAC)，最少四個角色：ADMIN、CLASS_TEACHER、PARENT、STUDENT
- **FR-012**: 系統必須根據使用者角色和班級註冊限制文章可見性
- **FR-013**: 系統必須防止使用者根據他們的角色存取未授權端點或資料
- **FR-014**: 系統必須支援教師指派到特定班級，只有指派班級的編輯權限
- **FR-015**: 系統必須支援親子關係，父母看到所有孩子班級內容

**魔法連結特定**:
- **FR-016**: 系統必須產生密碼學上安全的一次性魔法連結權杖
- **FR-017**: 系統必須傳送包含清楚說明和過期資訊的魔法連結電子郵件
- **FR-018**: 系統必須在 15 分鐘後過期魔法連結
- **FR-019**: 系統必須在首次使用後無效化魔法連結
- **FR-020**: 系統必須實施魔法連結請求的速率限制（每電子郵件每小時最多 5 個）

**安全性和合規性**:
- **FR-021**: 系統必須記錄所有認證事件，包括使用者 ID、時間戳、方法和結果
- **FR-022**: 系統必須實施失敗登入嘗試的速率限制（每 IP 每小時最多 10 次）
- **FR-023**: 系統必須防止常見攻擊：CSRF、XSS、透過參數化查詢的 SQL 注入
- **FR-024**: 系統必須對所有認證端點使用 HTTPS
- **FR-025**: 系統必須驗證所有 OAuth 提供者回應和簽名
- **FR-026**: 系統必須提供管理員介面以查看和搜尋認證稽核日誌
- **FR-027**: 系統必須對可疑認證模式發出警報（多個失敗嘗試、異常 IP 地址等）

**使用者管理**:
- **FR-028**: 系統必須在首次成功驗證時自動建立使用者設定檔
- **FR-029**: 系統必須允許使用者更新他們的設定檔資訊（名稱、電子郵件偏好設定）
- **FR-030**: 系統必須支援管理員重設使用者帳號或撤銷存取權的能力
- **FR-031**: 系統必須顯示目前工作階段資訊並允許使用者管理活躍工作階段

**電子郵件變更和工作階段無效化**:
- **FR-032**: 系統必須提供帳號設定介面，允許已驗證使用者輸入新電子郵件地址
- **FR-033**: 系統必須向新電子郵件地址發送驗證連結，用於確認電子郵件所有權
- **FR-034**: 系統必須在電子郵件驗證連結被點擊時更新使用者的電子郵件地址
- **FR-035**: 系統必須在電子郵件驗證完成時無效化該使用者的所有現有工作階段（跨所有裝置）
- **FR-036**: 系統必須防止舊電子郵件地址用於登入或其他認證流程
- **FR-037**: 系統必須在無效化工作階段時通知活躍裝置（例如，強制登出訊息）
- **FR-038**: 系統必須在使用者使用舊電子郵件嘗試登入時拒絕並提示使用新電子郵件
- **FR-039**: 系統必須記錄電子郵件變更事件到稽核日誌，包括舊電子郵件、新電子郵件和驗證時間戳
- **FR-040**: 系統必須在電子郵件變更驗證流程中實施速率限制（每使用者每小時最多 3 次新驗證請求）

### 關鍵實體

- **使用者**: 代表具有電子郵件、名稱、角色和認證中繼資料的已驗證使用者
  - 屬性: id、email、name、role (ADMIN|CLASS_TEACHER|PARENT|STUDENT)、created_at、last_login
  - 關係: 有許多 auth_methods、有一個 user_profile、有許多 sessions

- **認證方法**: 記錄連結到使用者的認證提供者
  - 屬性: id、user_id、provider (google|magic_link)、provider_id、linked_at
  - 關係: 屬於 user、有許多 auth_events

- **魔法連結權杖**: 用於無密碼電子郵件認證的臨時權杖
  - 屬性: id、email、token (hashed)、expires_at、used_at、created_at
  - 關係: 追蹤 auth_events

- **工作階段**: 跟蹤跨裝置的活躍使用者工作階段
  - 屬性: id、user_id、token、refresh_token、device_info、created_at、expires_at、last_activity_at
  - 關係: 屬於 user、有許多 auth_events

- **認證事件**: 所有認證活動的稽核日誌
  - 屬性: id、user_id、event_type (login|logout|token_refresh|linking)、method、ip_address、user_agent、success、timestamp
  - 關係: 屬於 user、可能參考 auth_method

- **使用者設定檔**: 延伸的使用者資訊和偏好設定
  - 屬性: id、user_id、avatar_url、phone、preferences (notification_email、language)、updated_at
  - 關係: 屬於 user

- **使用者角色**: 使用者與角色的對應及關係背景
  - 屬性: id、user_id、role、assigned_classes (教師用)、child_ids (家長用)、assigned_at
  - 關係: 屬於 user、參考 classes 和 children

---

## 成功標準 *(必填)*

### 可測量的成果

- **SC-001**: 使用者可以在到達登入頁面的 2 分鐘內通過 Google OAuth 或魔法連結登入
- **SC-002**: 95% 的魔法連結電子郵件在 2 分鐘內傳遞，使用者可以通過點擊連結完成認證
- **SC-003**: 工作階段重新整理以透明方式發生；當權杖在活動期間過期時，使用者體驗零中斷
- **SC-004**: 認證相關頁面載入時間在標準 4G 行動連線上不超過 3 秒
- **SC-005**: 系統成功處理 1,000 個並行認證請求而無錯誤
- **SC-006**: 99.9% 的 OAuth 認證嘗試成功完成；失敗被記錄以進行調查
- **SC-007**: 所有認證事件（登入、登出、帳號連結、魔法連結使用）在 10 秒內被捕獲到稽核日誌中
- **SC-008**: 速率限制防止每個電子郵件地址每小時超過 5 個魔法連結請求
- **SC-009**: 速率限制阻止每個 IP 地址每小時超過 10 個失敗登入嘗試
- **SC-010**: 從密碼型系統遷移後，85% 的活躍使用者在 30 天內成功遷移到新的無密碼系統
- **SC-011**: 零個未授權資料存取事件歸因於認證漏洞
- **SC-012**: 管理員可以在 5 秒內搜尋稽核日誌並識別任何認證事件
- **SC-013**: 連結了多個認證方法的使用者報告改進的帳號安全信心（上線後調查）
- **SC-014**: 多裝置登入順暢進行；使用者在 30 天內保持跨裝置登入狀態
- **SC-015**: 帳號連結在 1 分鐘內完成，摩擦力最小

---

## 假設

1. **Google OAuth**: 我們已在 Google Cloud Console 中註冊應用程式並具有有效的 OAuth 認證 (client ID、client secret)
2. **電子郵件服務**: 提供可靠的電子郵件服務（Supabase 郵件、SendGrid 或類似）用於傳送魔法連結電子郵件
3. **資料庫**: PostgreSQL 搭配 Supabase 是資料庫後端；遷移將納入版本控制
4. **現有認證**: 存在現有密碼型認證系統以遷移；舊版使用者需要過渡路徑
5. **HTTPS**: 生產環境對所有認證端點強制執行 HTTPS
6. **權杖過期**: 15 分鐘存取權杖生存期和 30 天重新整理權杖生存期對使用情況可以接受
7. **使用者同意**: Google OAuth 流程包含使用者同意；沒有預先存在的 Google 服務 API 整合
8. **稽核保留**: 認證稽核日誌至少保留 90 天以用於合規目的
9. **角色指派**: 管理員手動指派教師班級和親子關係；最初沒有來自外部系統的自動同步
10. **沒有預先存在的工作階段**: 現有密碼型權杖不自動遷移；使用者必須通過新方法重新驗證

---

## 依賴項和整合

- **Google OAuth 2.0 提供者**: 用於使用者認證的外部 OAuth 提供者
- **電子郵件服務**: 用於魔法連結傳遞的外部服務（SendGrid、Mailgun、Supabase）
- **Supabase Auth**: 管理權杖和工作階段驗證的後端認證服務
- **瀏覽器 localStorage/sessionStorage**: 用戶端工作階段持久化
- **PostgreSQL 稽核表**: 後端稽核日誌儲存
- **速率限制服務**: Supabase 或用於請求節流的自訂中間件

---

## 注釋

- 此規格說明基於 PR #9 中參考的現有密碼型認證系統
- 現有使用者的遷移策略超出此規格說明的範圍，但應在實施規劃中解決
- 雙因素認證 (2FA) 不包含在此範圍內，但建議用於未來的 P3 階段
- 遺失電子郵件/Google 存取權的帳號恢復在邊界情況中提到，但具體實施方法被推遲到規劃階段
- Google 之外的社交登入提供者（GitHub、Microsoft 等）不包含；應設計可擴展性但不初始實施
