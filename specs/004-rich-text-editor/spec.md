# 功能規格：富文本編輯器與多媒體支援

**功能分支**: `004-rich-text-editor`
**建立日期**: 2025-11-30
**狀態**: 草稿
**輸入**: 使用者描述："改進富文本編輯器以獲得更好的編輯體驗並支援多媒體內容（參考 Wordpress）
所見即所得編輯器整合
使用 Supabase Storage 上傳圖片（使其易於切換至 AWS S3）
YouTube 影片嵌入（內聯播放）
音訊檔案支援（內聯播放）
增強的 Markdown 支援"

## 澄清

### Session 2025-11-30

- Q: 考慮到專案中已使用 @uiw/react-md-editor 作為 Markdown 編輯器，新的富文本編輯器與現有實作的整合策略為何？ → A: 逐步遷移 - 保留現有 Markdown 編輯器作為備用，新編輯器作為主要介面，支援雙向切換

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 基本所見即所得文字編輯 (優先級: P1)

編輯者使用視覺化編輯器建立和格式化文章內容，支援常見的文字格式選項（粗體、斜體、標題、清單、連結）。編輯者在輸入時即可看到格式化的文字，無需撰寫 markdown 或 HTML。變更會自動儲存，發佈後正確呈現。新的富文本編輯器作為主要編輯介面。

**為何此優先級**: 這是基礎編輯體驗 - 編輯者在新增多媒體之前需要可靠的基本格式功能。沒有所見即所得功能，內容建立會更慢且容易出錯。

**獨立測試**: 建立新文章，應用各種文字格式（粗體、斜體、標題、清單、連結），儲存，並驗證格式化內容在編輯器和發佈檢視中正確顯示。

**驗收情境**:

1. **給定** 編輯者開啟新文章，**當** 他們輸入文字並對選定的文字應用粗體格式，**則** 文字在編輯器中顯示為粗體並以粗體格式發佈。
2. **給定** 編輯者正在撰寫內容，**當** 他們建立包含 3 個項目的項目符號清單，**則** 清單在編輯器和發佈檢視中都以適當的項目符號格式顯示。
3. **給定** 編輯者已格式化內容，**當** 他們建立指向外部網站的超連結，**則** 連結在發佈檢視中可點擊並顯示指定的文字。
4. **給定** 編輯者使用標題樣式（H1、H2、H3），**當** 文章發佈時，**則** 標題以適當的視覺層次顯示。

---

### 使用者故事 2 - 圖片上傳與管理 (優先級: P1)

編輯者透過拖放或選擇檔案直接將圖片上傳到文章中。圖片會自動針對網頁顯示進行最佳化並安全儲存。編輯者可以調整圖片大小、對齊方式並新增標題。系統支援切換儲存提供者而無需遷移內容。

**為何此優先級**: 視覺內容對於吸引人的電子報至關重要 - 圖片顯著增強讀者體驗，且是最常見的多媒體類型。

**獨立測試**: 透過拖放上傳圖片至文章，調整其大小和對齊方式，新增標題，儲存，並驗證圖片正確顯示且已應用最佳化。

**驗收情境**:

1. **給定** 編輯者正在撰寫文章，**當** 他們將圖片檔案（PNG、JPG）拖放到編輯器中，**則** 圖片上傳、內聯顯示並自動針對網頁傳遞進行最佳化。
2. **給定** 圖片已上傳，**當** 編輯者將圖片寬度調整為 50% 並設定置中對齊，**則** 圖片在發佈的文章中以 50% 寬度置中顯示。
3. **給定** 已上傳的圖片，**當** 編輯者在圖片下方新增標題，**則** 標題在發佈檢視中顯示於圖片下方。
4. **給定** 儲存在當前儲存提供者中的圖片，**當** 管理員配置不同的儲存提供者（例如，從 Supabase 切換到 AWS S3），**則** 新上傳使用新提供者而不影響現有圖片。

---

### 使用者故事 3 - 影片嵌入與播放 (優先級: P2)

編輯者透過貼上影片 URL 將 YouTube 影片嵌入文章中。影片以內聯播放控制項顯示，允許讀者在不離開頁面的情況下觀看。嵌入的影片具有回應式設計並在行動裝置上運作。

**為何此優先級**: 影片內容豐富電子報，但對於 MVP 來說不如文字和圖片重要。大多數電子報僅使用文字和圖片就能良好運作。

**獨立測試**: 在文章編輯器中貼上 YouTube URL，驗證其呈現為嵌入式播放器，發佈，並確認讀者可以在不導航的情況下內聯播放影片。

**驗收情境**:

1. **給定** 編輯者正在撰寫內容，**當** 他們貼上 YouTube 影片 URL（例如，https://www.youtube.com/watch?v=dQw4w9WgXcQ），**則** 編輯器自動將其轉換為嵌入式影片播放器。
2. **給定** 文章中的嵌入影片，**當** 讀者在桌面上檢視發佈的文章，**則** 他們可以使用標準 YouTube 控制項內聯播放影片。
3. **給定** 嵌入的影片，**當** 讀者在行動裝置上檢視文章，**則** 影片播放器具有回應式設計並保持長寬比。
4. **給定** 已嵌入影片，**當** 編輯者需要移除它，**則** 他們可以刪除影片嵌入，文章中的空間會被回收。

---

### 使用者故事 4 - 音訊檔案上傳與播放 (優先級: P2)

編輯者直接將音訊檔案（MP3、WAV）上傳到文章中，用於錄音、音樂或語音訊息等內容。音訊以內聯播放器顯示，具有標準控制項（播放、暫停、音量、進度條）。讀者可以收聽而無需下載檔案。

**為何此優先級**: 音訊內容對某些電子報類型（例如，教育內容、播客）有價值，但不像文字/圖片那樣普遍需要。

**獨立測試**: 上傳音訊檔案，驗證其在編輯器中顯示為播放控制項，發佈，並確認讀者可以使用標準控制項播放音訊。

**驗收情境**:

1. **給定** 編輯者正在撰寫內容，**當** 他們上傳音訊檔案（MP3 或 WAV 格式），**則** 檔案上傳並在編輯器中顯示為內聯音訊播放器。
2. **給定** 已上傳的音訊檔案，**當** 讀者檢視發佈的文章，**則** 他們看到具有播放/暫停、音量控制和進度條的音訊播放器。
3. **給定** 發佈檢視中的音訊播放器，**當** 讀者點擊播放，**則** 音訊內聯播放而無需下載檔案。
4. **給定** 一篇文章中有多個音訊檔案，**當** 讀者播放一個音訊檔案，**則** 只播放該檔案（不會自動排隊到下一個檔案）。

---

### 使用者故事 5 - Markdown 與 HTML 支援 (優先級: P3)

進階編輯者可以在所見即所得模式和 markdown/HTML 原始碼模式之間切換以進行精確控制。支援 Markdown 語法供熟悉它的使用者使用。在 markdown 中建立的內容在所見即所得檢視中正確呈現，反之亦然。系統保留現有的 @uiw/react-md-editor 作為 Markdown 專用編輯選項。

**為何此優先級**: 雖然進階使用者欣賞原始碼編輯，但大多數編輯者更喜歡所見即所得。這是針對進階工作流程的增強功能，而非核心功能。

**獨立測試**: 在所見即所得模式下建立內容，切換到 markdown 檢視以驗證正確轉換，在 markdown 中編輯，切換回來，並確認變更已保留。

**驗收情境**:

1. **給定** 編輯者已在所見即所得模式下建立格式化內容，**當** 他們切換到 markdown 原始碼檢視，**則** 內容顯示為有效的 markdown 語法。
2. **給定** 編輯者處於 markdown 模式，**當** 他們撰寫 markdown 語法（例如，`**粗體**`、`## 標題`），**則** 切換到所見即所得模式會顯示格式化結果。
3. **給定** 包含 markdown 建立和所見即所得建立內容的文章，**當** 發佈時，**則** 所有內容都正確呈現，無論建立方法如何。
4. **給定** 編輯者需要插入自訂 HTML，**當** 他們使用原始碼模式新增 HTML 標籤，**則** HTML 經過清理以確保安全，但允許的格式會被保留。

---

### 邊界情況

- 當編輯者上傳非常大的圖片檔案（例如，50MB）時會發生什麼？
- 系統如何處理不支援的檔案格式（例如，將 .docx 檔案作為圖片上傳）？
- 如果儲存提供者（Supabase/S3）在上傳期間變得不可用會發生什麼？
- 編輯器如何處理後來在 YouTube 上被刪除或設為私密的嵌入影片？
- 當編輯者貼上從 Microsoft Word 複製的具有複雜格式的內容時會發生什麼？
- 如果音訊檔案損壞或無法播放，系統如何回應？
- 當文章包含許多大型媒體檔案並接近儲存限制時會發生什麼？
- 如果文章被刪除，圖片/媒體如何處理 - 檔案是被移除還是存檔？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須提供所見即所得編輯器介面，具有視覺化格式控制項（粗體、斜體、底線、刪除線）。
- **FR-002**: 系統必須支援標題層級（H1、H2、H3、H4、H5、H6），在編輯器中具有視覺區別。
- **FR-003**: 系統必須支援有序（編號）和無序（項目符號）清單，具有巢狀清單功能。
- **FR-004**: 系統必須允許編輯者建立超連結，具有可自訂的顯示文字和 URL 驗證。
- **FR-005**: 系統必須支援透過拖放、檔案選擇器或從剪貼簿貼上來上傳圖片。
- **FR-006**: 系統必須自動針對網頁傳遞最佳化上傳的圖片（格式轉換、壓縮、回應式大小）。
- **FR-007**: 系統必須使用唯一識別碼儲存上傳的媒體檔案並防止檔案名稱衝突。
- **FR-008**: 系統必須支援可配置的儲存後端（Supabase Storage 為預設，AWS S3 為替代方案），透過抽象儲存介面。
- **FR-009**: 系統必須允許編輯者調整上傳圖片的屬性（寬度、對齊方式：左/中/右、替代文字、標題）。
- **FR-010**: 系統必須支援透過 URL 轉換為嵌入式播放器來嵌入 YouTube 影片。
- **FR-011**: 系統必須將嵌入的影片呈現為具有標準 YouTube 播放器控制項的回應式 iframe。
- **FR-012**: 系統必須支援音訊檔案上傳（MP3、WAV 格式），具有檔案大小驗證。
- **FR-013**: 系統必須將上傳的音訊呈現為 HTML5 音訊播放器，具有標準控制項（播放、暫停、音量、搜尋）。
- **FR-014**: 系統必須提供 markdown 原始碼編輯模式作為所見即所得的替代方案。
- **FR-015**: 系統必須在所見即所得內容和 markdown 語法之間雙向轉換而不遺失資料。
- **FR-016**: 系統必須清理使用者產生的 HTML 以防止 XSS 攻擊，同時保留安全的格式標籤。
- **FR-017**: 系統必須提供自動儲存功能以防止編輯期間內容遺失。
- **FR-018**: 系統必須驗證上傳的檔案類型，並以清晰的錯誤訊息拒絕不支援的格式。
- **FR-019**: 系統必須強制執行上傳的檔案大小限制（圖片：10MB，音訊：50MB），並提供使用者友善的錯誤訊息。
- **FR-020**: 系統必須在編輯器遷移期間保留現有的基於 markdown 的文章（向後相容性），包括保留現有的 @uiw/react-md-editor 作為備用編輯選項。
- **FR-021**: 系統必須追蹤媒體檔案使用情況，並允許管理員識別孤立檔案（任何文章中未引用的媒體）。
- **FR-022**: 系統必須提供媒體庫介面，供編輯者瀏覽和重複使用先前上傳的圖片/音訊。

### 關鍵實體 *(如果功能涉及資料則包含)*

- **媒體檔案**: 代表上傳的媒體（圖片、音訊），具有屬性：檔案 ID、檔案名稱、檔案類型（圖片/音訊）、MIME 類型、檔案大小、儲存 URL、上傳日期、上傳者使用者 ID、替代文字（用於圖片）、使用次數（引用文章計數）。
- **文章內容**: 增強的文章實體，具有支援混合文字、圖片、影片和音訊的富內容結構。內容儲存為結構化格式（JSON 或 HTML），保留格式和媒體引用。
- **儲存提供者配置**: 活動儲存後端（Supabase Storage 或 AWS S3）的系統配置，具有憑證、儲存桶名稱、區域，並透過介面抽象存取模式。
- **編輯器偏好設定**: 記錄編輯者的編輯器選擇（富文本或 Markdown），允許系統記住使用者偏好。

## 成功標準 *(必填)*

### 可衡量結果

- **SC-001**: 編輯者可以在 10 分鐘內建立並格式化包含圖片的 500 字文章（相比僅使用 markdown 編輯的 20 分鐘以上）。
- **SC-002**: 在標準寬頻連線上，5MB 以下檔案的圖片上傳和最佳化在 5 秒內完成。
- **SC-003**: 包含嵌入影片的文章在 95% 以上的讀者裝置（桌面、平板、行動）上成功顯示和播放。
- **SC-004**: 所見即所得編輯器支援 100 篇以上文章而不降低效能（頁面載入時間低於 2 秒，輸入延遲低於 100 毫秒）。
- **SC-005**: 儲存提供者可以在 1 小時內從 Supabase 切換到 AWS S3（或反之），無需內容遷移。
- **SC-006**: 90% 以上的編輯者在第一次嘗試時成功上傳和格式化圖片，無需查看說明文件。
- **SC-007**: 使用者產生的內容中零 XSS 漏洞（透過清理通過安全稽核）。
- **SC-008**: 自動儲存在 100% 的瀏覽器當機或網路中斷情境中防止內容遺失。
- **SC-009**: 媒體庫支援瀏覽和搜尋 1000 個以上上傳的檔案，結果在 1 秒內返回。
- **SC-010**: Markdown 到所見即所得和所見即所得到 Markdown 的轉換對常見格式（標題、清單、連結、粗體、斜體）保持 100% 內容保真度。

## 假設 *(選填 - 如不適用則移除)*

- **A-001**: 編輯者具有基本的電腦素養並理解常見的文字格式概念（粗體、斜體、清單）。
- **A-002**: 大多數編輯者更喜歡視覺化所見即所得編輯而非 markdown 語法。
- **A-003**: 電子報內容主要是文字和圖片，影片和音訊作為偶爾的增強功能。
- **A-004**: 上傳的媒體檔案平均每篇文章 2-3 張圖片，每張 500KB。
- **A-005**: Supabase Storage 或 AWS S3 的儲存成本對於預期的媒體量是可接受的。
- **A-006**: 嵌入文章中的 YouTube 影片將保持公開可訪問（系統不託管影片檔案）。
- **A-007**: 編輯者和讀者使用現代網頁瀏覽器（Chrome、Firefox、Safari、Edge - 最新 2 個版本）。
- **A-008**: 網路連線足夠穩定以進行檔案上傳（最低 1Mbps 上傳速度）。
- **A-009**: 資料庫中現有的 markdown 內容可以以程式方式轉換為富文本格式。
- **A-010**: 管理員有權透過環境變數或管理介面配置儲存提供者憑證。

## 依賴性 *(選填 - 如不適用則移除)*

- **D-001**: 需要 **002-database-structure** - 文章儲存架構必須支援富內容格式。
- **D-002**: 需要 **003-passwordless-auth** - 編輯者驗證以控制誰可以上傳媒體和編輯內容。
- **D-003**: 需要配置了 API 憑證的儲存提供者帳戶（Supabase Storage 或 AWS S3）。
- **D-004**: 需要選擇所見即所得編輯器函式庫（例如，TipTap、Lexical、ProseMirror 或類似）。
- **D-005**: 需要圖片最佳化函式庫或服務以進行自動壓縮和格式轉換。
- **D-006**: 現有的 **@uiw/react-md-editor** 套件（版本 3.x 或更高）繼續作為 Markdown 編輯選項。

## 超出範圍 *(選填 - 如不適用則移除)*

- **OS-001**: 即時協作編輯（多個編輯者同時編輯同一篇文章）。
- **OS-002**: 編輯器內的進階圖片編輯（裁剪、濾鏡、調整）- 僅支援基本調整大小。
- **OS-003**: 影片檔案上傳（直接託管影片）- 僅支援 YouTube 嵌入。
- **OS-004**: 文章內容的版本歷史和復原（可能在未來功能中新增）。
- **OS-005**: AI 輔助內容生成或文法檢查。
- **OS-006**: 文章的範本或預先設計的版面配置。
- **OS-007**: 共享文章的社群媒體預覽生成。
- **OS-008**: 排程發佈或內容日曆功能。
- **OS-009**: 完全移除現有的 @uiw/react-md-editor（保留作為備用選項）。
